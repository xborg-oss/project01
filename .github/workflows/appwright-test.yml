name: AppWright Test

on: [push]

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install qgjob CLI from PyPI
      run: pip install qgjob

    - name: Submit AppWright test and poll for status
      env:
        QGJOB_API_BASE_URL: http://localhost:8000  # or your deployed job-server API
      run: |
        qgjob submit \
          --org-id=qualgent \
          --app-version-id=xyz123 \
          --test=tests/onboarding.spec.ts \
          --target=emulator \
          --priority=1

        # Use the latest job ID from server
        JOB_ID=$(curl -s "$QGJOB_API_BASE_URL/jobs" | jq -r '.[-1].job_id')
        echo "Polling status for job: $JOB_ID"
        qgjob status --job-id "$JOB_ID" --poll
